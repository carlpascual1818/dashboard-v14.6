<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COO Dashboard</title>
  <script src="./config.js"></script>
  <style>
    :root {
      --bg1: #f6f8ff;
      --bg2: #eef6ff;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17, 24, 39, 0.10);
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
      --btn: #2563eb;
      --btnText: #ffffff;
      --chip: rgba(17,24,39,0.06);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 30% 10%, var(--bg2), var(--bg1));
      min-height: 100vh;
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
    }
    .brand {
      display:flex;
      gap:10px;
      align-items:center;
      font-weight: 800;
    }
    .brandLink{
      color:inherit;
      text-decoration:none;
    }
    .brandLink:hover{ opacity:.85; }
    .brand .bolt { color: var(--btn); }
    .headerLeft { display:flex; gap:10px; align-items:center; }
    .crumb { color: var(--muted); font-size: 13px; }
    .right { display:flex; gap:10px; align-items:center; }
    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.75);
      color: var(--muted);
      max-width: 420px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .btn {
      border: 0;
      background: var(--btn);
      color: var(--btnText);
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }
    .btn.secondary {
      background: rgba(17,24,39,0.06);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .layout {
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 14px;
      padding: 0 18px 18px;
    }
    aside {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,0.80);
      box-shadow: var(--shadow);
      min-height: calc(100vh - 88px);
      overflow:hidden;
    }
    .sideHead {
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content: space-between;
    }
    .sideTitle { font-weight: 800; }
    .sideSub { color: var(--muted); font-size: 12px; margin-top: 3px; }
    .sideBody { padding: 10px 8px; }
    .navItem {
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px 10px;
      border-radius: 12px;
      cursor: pointer;
      color: var(--text);
      border: 1px solid transparent;
    }
    .navItem:hover { background: rgba(17,24,39,0.04); }
    .navItem.active {
      background: rgba(37,99,235,0.10);
      border-color: rgba(37,99,235,0.25);
    }
    .navLabel { font-size: 13px; font-weight: 700; }
    .navMeta { font-size: 12px; color: var(--muted); }
    .navIndent { margin-left: 12px; padding-left: 10px; border-left: 1px dashed rgba(17,24,39,0.15); }

    main {
      display:flex;
      flex-direction: column;
      gap: 14px;
      min-height: calc(100vh - 88px);
    }
    .panel {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,0.85);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .panelTitle { font-weight: 900; }
    .panelSub { color: var(--muted); font-size: 12px; margin-top: 3px; }
    .panelBody { padding: 14px 16px 16px; }
    .gridCards {
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }
    .cardBtn {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      padding: 14px;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: var(--shadow);
      min-height: 90px;
    }
    .cardBtn:hover { transform: translateY(-2px); box-shadow: 0 14px 40px rgba(17,24,39,0.12); }
    .cardBtn .name { font-weight: 900; }
    .cardBtn .hint { margin-top: 6px; color: var(--muted); font-size: 12px; }
    .chips { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .chip { font-size: 12px; color: var(--muted); background: var(--chip); padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); }
    .toolbar {
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .field {
      display:flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    input[type="date"] {
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      font-size: 13px;
    }
    .tableWrap {
      width: 100%;
      overflow:auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(17,24,39,0.08);
      text-align: left;
      vertical-align: top;
      max-width: 420px;
      word-break: break-word;
    }
    th { position: sticky; top: 0; background: #f9fafb; z-index: 1; font-weight: 900; }
    .split {
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 14px;
      align-items: start;
    }
    .muted { color: var(--muted); }
    .spinner {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.60);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999;
      backdrop-filter: blur(3px);
    }
    .spinner .box {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.92);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      border-radius: 14px;
      font-weight: 800;
      color: var(--muted);
    }
    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      aside { min-height: auto; }
      .gridCards { grid-template-columns: 1fr; }
      .split { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="headerLeft">
      <a class="brand brandLink" href="./portal.html"><span class="bolt">âš¡</span><span>COO Dashboard</span></a>
      <div id="crumb" class="crumb"></div>
    </div>
    <div class="right">
      <button class="btn secondary" id="homeBtn">Home</button>
      <button class="btn secondary" id="backBtn">Back</button>
      <span id="userPill" class="pill">Loading...</span>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="layout">
    <aside id="sidebar"></aside>
    <main id="main"></main>
  </div>

  <div id="spinner" class="spinner"><div class="box">Loading...</div></div>

<script>
  const token = localStorage.getItem('token');
  const user = safeJson(localStorage.getItem('user')) || {};
  if (!token) location.href = './login.html';

  document.getElementById('userPill').textContent = (user.name ? user.name : (user.email || '')) + (user.role ? (' | ' + user.role) : '');

  document.getElementById('homeBtn').addEventListener('click', () => location.href = './portal.html');

  document.getElementById('backBtn').addEventListener('click', () => {
    if (window.history.length > 1) window.history.back();
    else location.href = './portal.html';
  });

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    sessionStorage.removeItem('nav_cache');
    sessionStorage.removeItem('nav_cache_ts');
    location.href = './login.html';
  });

  function safeJson(v){ try { return JSON.parse(v || ''); } catch(e){ return null; } }

  async function api(action, payload = {}) {
    const r = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, token, ...payload })
    });
    return await r.json();
  }

  function setNavCache(nav) {
    try {
      sessionStorage.setItem('nav_cache', JSON.stringify(nav));
      sessionStorage.setItem('nav_cache_ts', String(Date.now()));
    } catch(e){}
  }

  function getNavCache() {
    try {
      const raw = sessionStorage.getItem('nav_cache');
      if (!raw) return null;
      return JSON.parse(raw);
    } catch(e) { return null; }
  }

  function qs() { return new URLSearchParams(location.search); }
  function setQuery(params, replace=false) {
    const u = new URL(location.href);
    Object.keys(params).forEach(k => {
      const v = params[k];
      if (v === null || v === undefined || v === '') u.searchParams.delete(k);
      else u.searchParams.set(k, v);
    });
    if (replace) history.replaceState({}, '', u.toString());
    else history.pushState({}, '', u.toString());
  }

  function esc(s) {
    return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  function showSpinner(on) {
    document.getElementById('spinner').style.display = on ? 'flex' : 'none';
  }

  function getCategoryId(cat) {
    return (cat && (cat.category_id || cat.id || cat.slug || cat.name)) ? (cat.category_id || cat.id || cat.slug || cat.name) : '';
  }

  function getCategoryName(cat) {
    return (cat && (cat.display_name || cat.name || cat.category_name || cat.id)) ? (cat.display_name || cat.name || cat.category_name || cat.id) : 'Category';
  }

  function findCatById(rootCats, id) {
    if (!id) return null;
    const stack = [...(rootCats || [])];
    while (stack.length) {
      const c = stack.shift();
      if (String(getCategoryId(c)) === String(id)) return c;
      (c.children || []).forEach(ch => stack.push(ch));
    }
    return null;
  }

  function findPageLocation(rootCats, pageId) {
    if (!pageId) return null;
    const queue = (rootCats || []).map(cat => ({cat, path: [cat]}));
    while (queue.length) {
      const {cat, path} = queue.shift();
      if ((cat.pages || []).some(p => String(p.page_id) === String(pageId))) {
        return { section: path[0], dept: cat };
      }
      (cat.children || []).forEach(ch => queue.push({cat: ch, path: path.concat([ch])}));
    }
    return null;
  }

  function flattenCats(cat, depth=0) {
    const out = [];
    (cat.children || []).forEach(ch => {
      out.push({cat: ch, depth});
      const nested = flattenCats(ch, depth + 1);
      nested.forEach(x => out.push(x));
    });
    return out;
  }

  function countPages(cat) {
    let n = (cat.pages || []).length;
    (cat.children || []).forEach(ch => { n += countPages(ch); });
    return n;
  }

  function updateCrumb(sectionCat, deptCat, pageName) {
    const parts = [];
    if (sectionCat) parts.push(getCategoryName(sectionCat));
    if (deptCat) parts.push(getCategoryName(deptCat));
    if (pageName) parts.push(pageName);
    document.getElementById('crumb').textContent = parts.length ? ('/ ' + parts.join(' / ')) : '';
  }

  function renderSidebar(sectionCat, activeDeptId) {
    const sb = document.getElementById('sidebar');

    if (!sectionCat) {
      sb.innerHTML = `
        <div class="sideHead">
          <div>
            <div class="sideTitle">No section</div>
            <div class="sideSub">Go back to Home.</div>
          </div>
        </div>
        <div class="sideBody"></div>
      `;
      return;
    }

    const items = flattenCats(sectionCat, 0);

    const body = items.map(({cat, depth}) => {
      const isActive = (String(getCategoryId(cat)) === String(activeDeptId));
      const pages = (cat.pages || []).length;
      const kids = (cat.children || []).length;
      return `
        <div class="${depth ? 'navIndent' : ''}">
          <div class="navItem ${isActive ? 'active' : ''}" data-cat="${esc(getCategoryId(cat))}">
            <div>
              <div class="navLabel">${esc(getCategoryName(cat))}</div>
              <div class="navMeta">${pages ? (pages + ' pages') : (kids ? (kids + ' sub-depts') : ' ')}</div>
            </div>
          </div>
        </div>
      `;
    }).join('');

    sb.innerHTML = `
      <div class="sideHead">
        <div>
          <div class="sideTitle">${esc(getCategoryName(sectionCat))}</div>
          <div class="sideSub">Departments</div>
        </div>
      </div>
      <div class="sideBody">${body || '<div class="muted" style="padding:10px 10px;">No departments configured.</div>'}</div>
    `;

    sb.querySelectorAll('.navItem').forEach(el => {
      el.addEventListener('click', () => {
        const deptId = el.getAttribute('data-cat');
        setQuery({ dept_id: deptId, page_id: null }, false);
        render();
      });
    });
  }

  function renderDepartmentCards(sectionCat) {
    const kids = (sectionCat.children || []);
    return `
      <div class="panel">
        <div class="panelHead">
          <div>
            <div class="panelTitle">Departments</div>
            <div class="panelSub">Pick a department to continue.</div>
          </div>
        </div>
        <div class="panelBody">
          <div class="gridCards">
            ${kids.map(c => `
              <div class="cardBtn" data-dept="${esc(getCategoryId(c))}">
                <div class="name">${esc(getCategoryName(c))}</div>
                <div class="hint">${countPages(c)} pages${(c.children||[]).length ? (', ' + (c.children||[]).length + ' sub-depts') : ''}</div>
                <div class="chips">
                  ${(c.pages||[]).slice(0,3).map(p => `<span class="chip">${esc(p.display_name)}</span>`).join('')}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function renderDeptOrBranchCards(deptCat) {
    const kids = (deptCat.children || []);
    const pages = (deptCat.pages || []);
    const hasKids = kids.length > 0;

    // If this dept has sub-depts (like Customer Service -> CSR + Dispute Managers), show those first.
    if (hasKids) {
      return `
        <div class="panel">
          <div class="panelHead">
            <div>
              <div class="panelTitle">${esc(getCategoryName(deptCat))}</div>
              <div class="panelSub">Choose a branch.</div>
            </div>
          </div>
          <div class="panelBody">
            <div class="gridCards">
              ${kids.map(c => `
                <div class="cardBtn" data-dept="${esc(getCategoryId(c))}">
                  <div class="name">${esc(getCategoryName(c))}</div>
                  <div class="hint">${countPages(c)} pages</div>
                  <div class="chips">
                    ${(c.pages||[]).slice(0,3).map(p => `<span class="chip">${esc(p.display_name)}</span>`).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    // Otherwise show pages in this dept
    return `
      <div class="panel">
        <div class="panelHead">
          <div>
            <div class="panelTitle">${esc(getCategoryName(deptCat))}</div>
            <div class="panelSub">Choose a page.</div>
          </div>
        </div>
        <div class="panelBody">
          <div class="gridCards">
            ${pages.map(p => `
              <div class="cardBtn" data-page="${esc(p.page_id)}">
                <div class="name">${esc(p.display_name)}</div>
                <div class="hint">${p.view_type === 'chart' ? 'Chart' : 'Table'}${p.chart_type ? ' + trend' : ''}</div>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function parseISODateToLong(s) {
    if (!s) return null;
    const str = String(s).trim();
    // YYYY-MM-DD or ISO string
    const iso = (str.length === 10 && /^\d{4}-\d{2}-\d{2}$/.test(str)) ? (str + 'T00:00:00.000Z') : str;
    const d = new Date(iso);
    if (isNaN(d.getTime())) return null;
    const fmt = new Intl.DateTimeFormat('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    return fmt.format(d);
  }

  function renderTable(columns, rows) {
    const head = `<tr>${columns.map(c => `<th>${esc(c)}</th>`).join('')}</tr>`;
    const body = rows.map(r => {
      return `<tr>${r.map((v, i) => {
        const col = String(columns[i] || '').toLowerCase();
        if (col.includes('date')) {
          const nice = parseISODateToLong(v);
          if (nice) return `<td>${esc(nice)}</td>`;
        }
        return `<td>${esc(v)}</td>`;
      }).join('')}</tr>`;
    }).join('');
    return `<div class="tableWrap"><table><thead>${head}</thead><tbody>${body}</tbody></table></div>`;
  }

  function shouldShowTrend(page, columns, rows) {
    if (!page) return false;
    if (!rows || rows.length < 2) return false;

    const x = (page.x_axis || '').trim().toLowerCase();
    const y = (page.y_axis || '').trim().toLowerCase();

    if (!page.chart_type) return false;
    if (!x || !y) return false;

    const colIndex = {};
    columns.forEach((c,i) => colIndex[String(c||'').toLowerCase()] = i);

    if (!(x in colIndex) || !(y in colIndex)) return false;

    // Check numeric y
    let numeric = 0;
    for (let i=0; i<Math.min(rows.length, 25); i++) {
      const val = rows[i][colIndex[y]];
      const num = Number(val);
      if (!isNaN(num)) numeric++;
    }
    return numeric >= 3;
  }

  async function ensureChartJs() {
    if (window.Chart) return;
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  async function renderTrend(page, columns, rows) {
    const xKey = String(page.x_axis || '').toLowerCase();
    const yKey = String(page.y_axis || '').toLowerCase();

    const colIndex = {};
    columns.forEach((c,i) => colIndex[String(c||'').toLowerCase()] = i);

    const xi = colIndex[xKey];
    const yi = colIndex[yKey];

    const labels = [];
    const data = [];
    rows.forEach(r => {
      labels.push(String(r[xi] || ''));
      data.push(Number(r[yi] || 0));
    });

    await ensureChartJs();

    return `
      <div class="panel">
        <div class="panelHead">
          <div>
            <div class="panelTitle">Trend</div>
            <div class="panelSub">Based on ${esc(page.display_name)}</div>
          </div>
        </div>
        <div class="panelBody">
          <div style="border:1px solid var(--border); border-radius:14px; background:white; padding:10px;">
            <canvas id="trendChart" height="140"></canvas>
          </div>
        </div>
      </div>
    `;
  }

  async function drawTrend(page, columns, rows) {
    const xKey = String(page.x_axis || '').toLowerCase();
    const yKey = String(page.y_axis || '').toLowerCase();

    const colIndex = {};
    columns.forEach((c,i) => colIndex[String(c||'').toLowerCase()] = i);
    const xi = colIndex[xKey];
    const yi = colIndex[yKey];

    const labels = rows.map(r => String(r[xi] || ''));
    const data = rows.map(r => Number(r[yi] || 0));

    const ctx = document.getElementById('trendChart').getContext('2d');
    new Chart(ctx, {
      type: page.chart_type || 'line',
      data: { labels, datasets: [{ label: page.display_name, data }] },
      options: { responsive: true, maintainAspectRatio: false }
    });
  }

  async function renderPage(pageId, deptCat, sectionCat) {
    const main = document.getElementById('main');
    showSpinner(true);

    const start = qs().get('start') || '';
    const end = qs().get('end') || '';

    const res = await api('page', { page_id: pageId, filters: { start_date: start, end_date: end } });

    showSpinner(false);

    if (!res || !res.success) {
      main.innerHTML = `
        <div class="panel">
          <div class="panelHead"><div><div class="panelTitle">Error</div></div></div>
          <div class="panelBody"><div class="muted">${esc((res && res.error) ? res.error : 'Failed to load.')}</div></div>
        </div>
      `;
      return;
    }

    const page = res.page || {};
    const cols = page.columns || [];
    const rows = page.rows || [];

    updateCrumb(sectionCat, deptCat, page.display_name);

    const toolbar = `
      <div class="toolbar">
        <div class="field">
          <div>Start date</div>
          <input id="startDate" type="date" value="${esc((qs().get('start')||''))}">
        </div>
        <div class="field">
          <div>End date</div>
          <input id="endDate" type="date" value="${esc((qs().get('end')||''))}">
        </div>
        <button class="btn secondary" id="reloadBtn">Reload</button>
      </div>
    `;

    const dataPanel = `
      <div class="panel">
        <div class="panelHead">
          <div>
            <div class="panelTitle">${esc(page.display_name || page.page_id)}</div>
            <div class="panelSub">Table: ${esc(page.table || '')}</div>
          </div>
          <div>${toolbar}</div>
        </div>
        <div class="panelBody">
          ${rows.length ? renderTable(cols, rows) : '<div class="muted">No data.</div>'}
        </div>
      </div>
    `;

    const wantTrend = shouldShowTrend(page, cols, rows);
    if (wantTrend) {
      const trendHtml = await renderTrend(page, cols, rows);
      main.innerHTML = `<div class="split">${dataPanel}${trendHtml}</div>`;
      await drawTrend(page, cols, rows);
    } else {
      main.innerHTML = dataPanel;
    }

    // Wire reload
    document.getElementById('reloadBtn').addEventListener('click', () => {
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      setQuery({ start: s || null, end: e || null }, false);
      render();
    });
  }

  let NAV = null;

  async function loadNav() {
    const cached = getNavCache();
    if (cached && cached.categories) return cached;

    const res = await api('nav');
    if (!res || !res.success) throw new Error((res && res.error) ? res.error : 'Failed to load nav');
    setNavCache(res.nav);
    return res.nav;
  }

  async function render() {
    const main = document.getElementById('main');

    const catId = qs().get('cat_id');
    const deptId = qs().get('dept_id');
    const pageId = qs().get('page_id');

    if (!NAV) {
      try { NAV = await loadNav(); }
      catch(e) {
        main.innerHTML = `<div class="panel"><div class="panelHead"><div class="panelTitle">Error</div></div><div class="panelBody"><div class="muted">${esc(e.message)}</div></div></div>`;
        return;
      }
    }

    const roots = NAV.categories || [];
    let sectionCat = findCatById(roots, catId);
    let resolvedDeptId = deptId;

    if (!sectionCat && pageId) {
      const loc = findPageLocation(roots, pageId);
      if (loc) {
        sectionCat = loc.section;
        resolvedDeptId = getCategoryId(loc.dept);
        setQuery({ cat_id: getCategoryId(loc.section), dept_id: resolvedDeptId }, true);
      }
    }

    renderSidebar(sectionCat, resolvedDeptId);

    if (!sectionCat) {
      updateCrumb(null, null, null);
      main.innerHTML = `
        <div class="panel">
          <div class="panelHead"><div><div class="panelTitle">Pick a section</div><div class="panelSub">Go to Home and choose Team, Ops, Finance, or HR.</div></div></div>
        </div>
      `;
      return;
    }

    // If only section selected -> show departments
    if (!resolvedDeptId) {
      updateCrumb(sectionCat, null, null);
      main.innerHTML = renderDepartmentCards(sectionCat);
      main.querySelectorAll('[data-dept]').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.getAttribute('data-dept');
          setQuery({ dept_id: id, page_id: null }, false);
          render();
        });
      });
      return;
    }

    const deptCat = findCatById(sectionCat.children || [], resolvedDeptId) || findCatById([sectionCat], resolvedDeptId);

    if (!deptCat) {
      updateCrumb(sectionCat, null, null);
      main.innerHTML = `
        <div class="panel">
          <div class="panelHead"><div><div class="panelTitle">Department not found</div><div class="panelSub">Check your config.</div></div></div>
        </div>
      `;
      return;
    }

    // If dept selected but no page -> show dept branches or pages
    if (!pageId) {
      updateCrumb(sectionCat, deptCat, null);
      main.innerHTML = renderDeptOrBranchCards(deptCat);

      main.querySelectorAll('[data-dept]').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.getAttribute('data-dept');
          setQuery({ dept_id: id, page_id: null }, false);
          render();
        });
      });

      main.querySelectorAll('[data-page]').forEach(el => {
        el.addEventListener('click', () => {
          const id = el.getAttribute('data-page');
          setQuery({ page_id: id }, false);
          render();
        });
      });

      return;
    }

    // Page view
    await renderPage(pageId, deptCat, sectionCat);
  }

  window.addEventListener('popstate', () => render());

  // Boot
  (function boot() {
    // If user came here without section, send them home
    if (!qs().get('cat_id') && !qs().get('page_id')) {
      location.href = './portal.html';
      return;
    }
    render();
  })();
</script>
</body>
</html>

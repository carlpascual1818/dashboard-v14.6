<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>COO Dashboard - Home</title>
  <script src="./config.js"></script>
  <style>
    :root {
      --bg1: #f6f8ff;
      --bg2: #eef6ff;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17, 24, 39, 0.10);
      --shadow: 0 10px 30px rgba(17, 24, 39, 0.08);
      --btn: #2563eb;
      --btnText: #ffffff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 30% 10%, var(--bg2), var(--bg1));
      min-height: 100vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 22px;
    }
    .brand {
      display: flex;
      gap: 10px;
      align-items: center;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .brand .bolt { font-size: 18px; color: var(--btn); }
    .right {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.75);
      color: var(--muted);
    }
    .btn {
      border: 0;
      background: var(--btn);
      color: var(--btnText);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn.secondary {
      background: rgba(17,24,39,0.06);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 8px 22px 28px;
    }
    .hero {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 22px;
      border: 1px solid var(--border);
      border-radius: 18px;
      background: rgba(255,255,255,0.70);
      box-shadow: var(--shadow);
    }
    .hero h1 {
      margin: 0;
      font-size: 36px;
      line-height: 1.05;
    }
    .hero p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    .grid {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 18px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 18px;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease;
      display: grid;
      grid-template-columns: 54px 1fr;
      gap: 14px;
      align-items: start;
      min-height: 110px;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 40px rgba(17, 24, 39, 0.12);
    }
    .iconBox {
      width: 54px;
      height: 54px;
      border-radius: 14px;
      background: rgba(37, 99, 235, 0.10);
      display: grid;
      place-items: center;
      font-size: 22px;
      color: var(--btn);
    }
    .card h3 { margin: 0; font-size: 18px; }
    .card p { margin: 6px 0 0; color: var(--muted); font-size: 13px; }
    .metaRow { margin-top: 10px; display:flex; gap:10px; flex-wrap: wrap; }
    .mini {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(17,24,39,0.03);
      color: var(--muted);
    }
    .loading {
      margin-top: 18px;
      color: var(--muted);
      font-size: 14px;
    }
    @media (max-width: 820px) {
      .grid { grid-template-columns: 1fr; }
      .hero h1 { font-size: 28px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><span class="bolt">âš¡</span><span>COO Dashboard</span></div>
    <div class="right">
      <span id="userPill" class="pill">Loading...</span>
      <button class="btn secondary" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div class="hero">
      <h1 id="welcomeTitle">Welcome back</h1>
      <p>Choose where you would like to go.</p>
    </div>

    <div id="grid" class="grid"></div>
    <div id="loading" class="loading">Loading your access...</div>
  </div>

<script>
  const token = localStorage.getItem('token');
  const user = safeJson(localStorage.getItem('user')) || {};
  const userName = user.name || user.email || 'User';

  if (!token) location.href = './login.html';

  document.getElementById('welcomeTitle').textContent = 'Welcome back, ' + (user.name || 'Demo') + '!';

  document.getElementById('userPill').textContent = (user.name ? user.name : (user.email || '')) + (user.role ? (' | ' + user.role) : '');

  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    sessionStorage.removeItem('nav_cache');
    sessionStorage.removeItem('nav_cache_ts');
    location.href = './login.html';
  });

  function safeJson(v){ try { return JSON.parse(v || ''); } catch(e){ return null; } }

  async function api(action, payload = {}) {
    const r = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, token, ...payload })
    });
    return await r.json();
  }

  function setNavCache(nav) {
    try {
      sessionStorage.setItem('nav_cache', JSON.stringify(nav));
      sessionStorage.setItem('nav_cache_ts', String(Date.now()));
    } catch(e){}
  }

  function getNavCache() {
    try {
      const raw = sessionStorage.getItem('nav_cache');
      if (!raw) return null;
      return JSON.parse(raw);
    } catch(e) { return null; }
  }

  function topIcon(id) {
    const key = String(id || '').toLowerCase();
    if (key.includes('team')) return 'ðŸ‘¥';
    if (key.includes('ops')) return 'âš™ï¸';
    if (key.includes('fin')) return 'ðŸ“ˆ';
    if (key.includes('hr')) return 'ðŸ“‹';
    return 'ðŸ“Œ';
  }

  function countPages(cat) {
    let n = (cat.pages || []).length;
    (cat.children || []).forEach(ch => { n += countPages(ch); });
    return n;
  }

  function renderCards(nav) {
    const roots = (nav.categories || []).filter(c => !c.parent_category_id);
    const grid = document.getElementById('grid');
    grid.innerHTML = '';

    roots.forEach(cat => {
      const totalPages = countPages(cat);
      const totalDepts = (cat.children || []).length;

      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="iconBox">${topIcon(cat.category_id)}</div>
        <div>
          <h3>${escapeHtml(cat.display_name || cat.category_id)}</h3>
          <p>${totalDepts ? (totalDepts + ' departments') : 'Open section'}</p>
          <div class="metaRow">
            <span class="mini">${totalPages} pages</span>
          </div>
        </div>
      `;
      el.addEventListener('click', () => {
        sessionStorage.setItem('last_url', location.href);
        location.href = './dashboard.html?cat_id=' + encodeURIComponent(cat.category_id);
      });
      grid.appendChild(el);
    });
  }

  function escapeHtml(s) {
    return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  (async function boot() {
    const cached = getNavCache();
    if (cached && cached.categories) {
      document.getElementById('loading').style.display = 'none';
      renderCards(cached);
      return;
    }

    const res = await api('nav');
    if (!res || !res.success) {
      document.getElementById('loading').textContent = (res && res.error) ? res.error : 'Failed to load.';
      return;
    }

    setNavCache(res.nav);
    document.getElementById('loading').style.display = 'none';
    renderCards(res.nav);
  })();
</script>
</body>
</html>
